services:
  # Mock SimpleFIN Server
  # Provides a fake SimpleFIN API for testing bank sync functionality
  mock-simplefin:
    build:
      context: .
      dockerfile: Dockerfile.mock-simplefin
    ports:
      - '8080:8080'
    environment:
      - MOCK_SIMPLEFIN_PORT=8080
      - MOCK_SIMPLEFIN_USERNAME=test
      - MOCK_SIMPLEFIN_PASSWORD=test123
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:8080/health']
      interval: 5s
      timeout: 5s
      retries: 3
      start_period: 5s
    restart: 'no'

  actual-server:
    image: actualbudget/actual-server:latest
    ports:
      - '5006:5006'
    volumes:
      - actual-data:/data
    healthcheck:
      test: ['CMD-SHELL', 'node src/scripts/health-check.js']
      interval: 5s
      timeout: 10s
      retries: 12
      start_period: 15s
    restart: 'no'
    depends_on:
      mock-simplefin:
        condition: service_healthy

  e2e-tests:
    build:
      context: .
      dockerfile: Dockerfile.e2e
    depends_on:
      actual-server:
        condition: service_healthy
      mock-simplefin:
        condition: service_healthy
    environment:
      - ACTUAL_SERVER_URL=http://actual-server:5006
      - ACTUAL_SERVER_PASSWORD=test-password-e2e
      - ACTUAL_DATA_DIR=/app/e2e-data
      # Mock SimpleFIN config (for mock server tests)
      - MOCK_SIMPLEFIN_PORT=8080
      - MOCK_SIMPLEFIN_URL=http://mock-simplefin:8080
      - MOCK_SIMPLEFIN_ACCESS_KEY=http://test:test123@mock-simplefin:8080/
      # Real SimpleFIN tokens (for multi-budget tests with beta-bridge.simplefin.org)
      # SIMPLEFIN_SETUP_TOKEN: Base64-encoded claim URL (e.g., aHR0cHM6Ly9iZXRh...)
      #   - One-time use token that must be claimed to get an access key
      #   - Obtained from SimpleFIN developer portal
      # SIMPLEFIN_ACCESS_KEY: Pre-claimed access URL with embedded credentials
      #   - Format: https://username:password@bridge.simplefin.org/simplefin/
      #   - Use this if token was already claimed
      - SIMPLEFIN_SETUP_TOKEN_1=${SIMPLEFIN_SETUP_TOKEN_1:-}
      - SIMPLEFIN_SETUP_TOKEN_2=${SIMPLEFIN_SETUP_TOKEN_2:-}
      - SIMPLEFIN_ACCESS_KEY_1=${SIMPLEFIN_ACCESS_KEY_1:-}
      - SIMPLEFIN_ACCESS_KEY_2=${SIMPLEFIN_ACCESS_KEY_2:-}
    volumes:
      - e2e-data:/app/e2e-data

volumes:
  actual-data:
  e2e-data:
